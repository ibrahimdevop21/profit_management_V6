---
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import { Icon } from 'astro-icon/components';
import type { Faqs as Props } from '~/types';

const {
  title = '',
  subtitle = '',
  tagline = '',
  items = [],
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;
---

<WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-4xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
  <Headline title={title} subtitle={subtitle} tagline={tagline} classes={classes} />
  
  <div class="accordion-container space-y-4 mt-8" data-accordion-id={id || 'faq'}>
    {items.map((item, index) => (
      <div class="accordion-item bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
        <button 
          class="accordion-header w-full px-6 py-4 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-[#01407a] focus:ring-opacity-50 rounded-lg"
          data-accordion-target={`accordion-content-${id || 'faq'}-${index}`}
          aria-expanded="false"
          aria-controls={`accordion-content-${id || 'faq'}-${index}`}
        >
          <h3 class="text-lg font-semibold text-gray-900 pr-4">{item.title}</h3>
          <div class="accordion-icon flex-shrink-0 transition-transform duration-200">
            <Icon name="tabler:chevron-down" class="w-5 h-5 text-[#01407a]" />
          </div>
        </button>
        
        <div 
          id={`accordion-content-${id || 'faq'}-${index}`}
          class="accordion-content overflow-hidden transition-all duration-300 ease-in-out max-h-0"
          aria-labelledby={`accordion-header-${id || 'faq'}-${index}`}
        >
          <div class="px-6 pb-4 pt-0">
            <div class="border-t border-gray-100 pt-4">
              <p class="text-gray-700 leading-relaxed" set:html={item.description} />
            </div>
          </div>
        </div>
      </div>
    ))}
  </div>
</WidgetWrapper>

<style>
  .accordion-item {
    transition: all 0.2s ease-in-out;
  }
  
  .accordion-header:hover {
    background-color: #f8fafc;
  }
  
  .accordion-content {
    transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
    opacity: 0;
  }
  
  .accordion-content.expanded {
    opacity: 1;
  }
  
  .accordion-icon {
    transition: transform 0.2s ease-in-out;
  }
  
  .accordion-header[aria-expanded="true"] .accordion-icon {
    transform: rotate(180deg);
  }
  
  .accordion-header[aria-expanded="true"] {
    background-color: #f1f5f9;
  }
</style>

<script>
  // Use a more robust initialization approach
  function initializeAccordion() {
    // Wait for both DOM and all resources to be ready
    const accordionContainers = document.querySelectorAll('.accordion-container');
    
    accordionContainers.forEach(container => {
      const accordionId = container.getAttribute('data-accordion-id') || 'default';
      const accordionHeaders = container.querySelectorAll('.accordion-header');
      
      // Remove existing event listeners to prevent duplicates
      accordionHeaders.forEach(header => {
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);
      });
      
      // Re-select headers after cloning
      const newHeaders = container.querySelectorAll('.accordion-header');
      
      newHeaders.forEach(header => {
        header.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const targetId = this.getAttribute('data-accordion-target');
          if (!targetId) return;
          
          const content = document.getElementById(targetId);
          const icon = this.querySelector('.accordion-icon');
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          
          if (!content) {
            console.warn('Accordion content not found:', targetId);
            return;
          }
          
          // Close all other accordion items in this container
          newHeaders.forEach(otherHeader => {
            if (otherHeader !== this) {
              const otherTargetId = otherHeader.getAttribute('data-accordion-target');
              if (!otherTargetId) return;
              
              const otherContent = document.getElementById(otherTargetId);
              
              if (otherContent) {
                otherHeader.setAttribute('aria-expanded', 'false');
                otherContent.classList.remove('expanded');
                otherContent.style.maxHeight = '0px';
              }
            }
          });
          
          // Toggle current accordion item
          if (isExpanded) {
            this.setAttribute('aria-expanded', 'false');
            content.classList.remove('expanded');
            content.style.maxHeight = '0px';
          } else {
            this.setAttribute('aria-expanded', 'true');
            content.classList.add('expanded');
            
            // Force reflow before setting height
            content.offsetHeight;
            content.style.maxHeight = content.scrollHeight + 'px';
            
            // Optional smooth scroll with delay
            setTimeout(() => {
              if (this.scrollIntoView) {
                this.scrollIntoView({ 
                  behavior: 'smooth', 
                  block: 'nearest' 
                });
              }
            }, 200);
          }
        });
      });
    });
  }
  
  // Multiple initialization attempts to handle timing issues
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAccordion);
  } else {
    initializeAccordion();
  }
  
  // Also initialize after window load for better compatibility
  window.addEventListener('load', () => {
    setTimeout(initializeAccordion, 100);
  });
  
  // Initialize on Astro page transitions (if using view transitions)
  document.addEventListener('astro:page-load', initializeAccordion);
</script>
